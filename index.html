<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–í–∞–ª–µ–Ω—Ç–∏–Ω–∫–∞ üíñ</title>
<style>
body {
    margin: 0;
    overflow: hidden;
    font-family: Arial, sans-serif;
    background: linear-gradient(#ff9ecb, #ffcce0);
}

/* –í–µ—Ä—Ö */
#topUI {
    position: absolute;
    top: 10px;
    width: 100%;
    display: flex;
    justify-content: center;
    gap: 30px;
}

#scoreBox {
    font-size: 58px;
    color: white;
    font-weight: bold;
    text-shadow: 0 0 8px #ff4da6;
}

/* –ü–∞–∑–ª */
#heartPuzzle {
    display: grid;
    grid-template-columns: repeat(5, 58px);
    gap: 15px;
}

.piece {
    font-size: 58px;
    filter: grayscale(1) brightness(0.6);
    color: red;
}

.piece.active {
    filter: none;
}

/* –ö–æ—Ä–∑–∏–Ω–∞ */
#basket {
    position: absolute;
    bottom: 20px;
    width: 100px;
    height: 40px;
    background: #8b4513;
    border-radius: 0 0 20px 20px;
}

/* –ü–∞–¥–∞—é—â–∏–µ */
.fall {
    position: absolute;
    font-size: 50px;
}

/* ===== –ö–û–ù–í–ï–†–¢ ===== */

#envelope {
    position: absolute;
    width: 340px;
    height: 240px;
    transform: scale(0);
    z-index: 20;
}

/* –û—Å–Ω–æ–≤–∞–Ω–∏–µ */
#envBase {
    width: 100%;
    height: 100%;
    background: #fff;
    border: 3px solid #d63384;
    position: absolute;
}

/* 4 —Å—Ç–≤–æ—Ä–∫–∏ */
.flap {
    position: absolute;
    background: #ffd6ea;
    transition: 0.8s;
}

#flapTop {
    width: 100%;
    height: 50%;
    top: 0;
    transform-origin: top;
    clip-path: polygon(0 0,100% 0,50% 100%);
}

#flapBottom {
    width: 100%;
    height: 50%;
    bottom: -10px;
    transform-origin: bottom;
    clip-path: polygon(0 100%,100% 100%,50% 0);
}

#flapLeft {
    width: 50%;
    height: 100%;
    left: 0;
    transform-origin: left;
    clip-path: polygon(0 0,100% 50%,0 100%);
}

#flapRight {
    width: 50%;
    height: 100%;
    right: -10px;
    transform-origin: right;
    clip-path: polygon(100% 0,0 50%,100% 100%);
}

/* –û—Ç–∫—Ä—ã—Ç–∏–µ */
.open #flapTop { transform: rotateX(180deg); }
.open #flapBottom { transform: rotateX(-180deg); }
.open #flapLeft { transform: rotateY(-180deg); }
.open #flapRight { transform: rotateY(180deg); }

/* –ë—É–º–∞–≥–∞ */
#paper {
    position: absolute;
    inset: 15px;
    background: #fff0f6;
    padding: 20px;
    font-size: 22px;
    color: #d63384;
    opacity: 0;
    transition: 0.5s;
}

.open #paper {
    opacity: 1;
    transition-delay: 0.7s;
}
</style>
</head>
<body>

<div id="game">
<div id="topUI">
    <div id="scoreBox">0 / 15</div>
    <div id="heartPuzzle"></div>
</div>
<div id="basket"></div>
</div>

<!-- –ö–û–ù–í–ï–†–¢ -->
<div id="envelope">
    <div id="envBase"></div>
    <div id="flapTop" class="flap"></div>
    <div id="flapBottom" class="flap"></div>
    <div id="flapLeft" class="flap"></div>
    <div id="flapRight" class="flap"></div>
    <div id="paper"></div>
</div>

<script>
const basket = document.getElementById("basket");
const scoreBox = document.getElementById("scoreBox");
const puzzle = document.getElementById("heartPuzzle");
const envelope = document.getElementById("envelope");
const paper = document.getElementById("paper");

let score = 0;
let speed = 4;
let paused = false;
let no_letter = 0;
let probab_black = 0.5;

/* –ü–∞–∑–ª */
for (let i = 0; i < 15; i++) {
    const piece = document.createElement("div");
    piece.className = "piece";
    piece.textContent = "‚ù§";
    puzzle.appendChild(piece);
}
const pieces = document.querySelectorAll(".piece");

/* –ö–æ—Ä–∑–∏–Ω–∞ */
let basketX = window.innerWidth / 2 - 50;
basket.style.left = basketX + "px";

document.addEventListener("mousemove", e => {
    if (paused) return;
    basketX = e.clientX - 50;
    basket.style.left = basketX + "px";
});

function removeAllLetters() {
    document.querySelectorAll('.fall').forEach(obj => {
        if (obj.dataset.type === "letter") {
            obj.remove();
        }
    });
}

/* –ü–∞–¥–µ–Ω–∏–µ */
function spawnObject() {
    if (paused) return;

    const obj = document.createElement("div");
    obj.className = "fall";

    let type = "heart";

    if (no_letter === 0 && score >= 15 && Math.random() < 0.25) {
        type = "letter";
        obj.textContent = "‚úâ";
    } else {
        obj.textContent = "‚ù§";
        obj.style.color = Math.random() < probab_black ? "black" : "red";
    }

    obj.dataset.type = type;

    obj.style.left = Math.random() * (window.innerWidth - 50) + "px";
    obj.style.top = "-50px";
    document.body.appendChild(obj);

    let y = -50;

    const fall = setInterval(() => {
        
        if (paused) return;

        if (y > window.innerHeight) {
            obj.remove();
            clearInterval(fall);
        }

        y += speed;
        obj.style.top = y + "px";

        const o = obj.getBoundingClientRect();
        const b = basket.getBoundingClientRect();

        if (o.bottom >= b.top && o.left < b.right && o.right > b.left) {
            obj.remove();
            clearInterval(fall);

            if (type === "letter") {
                catchLetter(o.left + o.width/2, o.top + o.height/2);
                return;
            }

            if (obj.style.color === "black" && no_letter === 0) {
                if (score > 0) {
                    score--;
                    pieces[score].classList.remove("active");
                }
            } else {
                if (score < 15 && no_letter === 0) pieces[score].classList.add("active");
                score++;
            }

            scoreBox.textContent = `${score} / 15`;
        }

    }, 20);
}

setInterval(spawnObject, 800);

/* –ü–û–ò–ú–ö–ê –ü–ò–°–¨–ú–ê */
function catchLetter(x, y) {

    removeAllLetters();

    no_letter = 1;
    probab_black = 0;
    speed = 0.7;

    // –ø–æ–∑–∏—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∏–∑ —Ç–æ—á–∫–∏ –ø–æ–∏–º–∫–∏
    envelope.style.left = x + "px";
    envelope.style.top = y + "px";
    envelope.style.transform = "translate(-50%, -50%) scale(0.1)";
    envelope.style.display = "block";

    // —Ä–æ—Å—Ç
    setTimeout(() => {
        envelope.style.transition = "0.6s";
        envelope.style.left = "50%";
        envelope.style.top = "50%";
        envelope.style.transform = "translate(-50%, -50%) scale(1)";
    }, 50);

    // –æ—Ç–∫—Ä—ã—Ç–∏–µ —Å—Ç–≤–æ—Ä–æ–∫
    setTimeout(() => {
        envelope.classList.add("open");
    }, 700);

    // –ø–µ—á–∞—Ç—å —Ç–µ–∫—Å—Ç–∞
    setTimeout(typeLetter, 1400);
}

/* –ü–µ—á–∞—Ç—å */
const message = `–î–∞—Ä—é —Ç–µ–±–µ –≤–∞–ª–µ–Ω—Ç–∏–Ω–∫—É,\nüíñ–º–æ—è –ª—é–±–∏–º–∫–∞üíñ`;

function typeLetter() {
    let i = 0;
    function type() {
        if (i < message.length) {
            paper.textContent += message[i];
            i++;
            setTimeout(type, 40);
        }
    }
    type();
}
</script>

</body>
</html>
